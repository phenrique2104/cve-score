import "./search.style.css"
import { useState, useEffect } from "react";
import { useCveApi } from "../../../api/cveApi/useCveApi";
import { Table } from "../table/table";
import { ToastContainer, toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';

export const Search = () => {

  const [send, setSend] = useState(false);
  const [cve, setCve] = useState('');
  const [year, setYear] = useState('2021');
  const [data, setData] = useState();
  const cveApi = useCveApi();


  useEffect(() => {
    if (send) {
      async function getCve() {
        try {
          toast.warn('Loading...', {
            position: "top-right",
            autoClose: 5000,
            hideProgressBar: false,
            closeOnClick: true,
            pauseOnHover: true,
            draggable: true,
            progress: undefined,
          });
          const response = await cveApi.GetCve(
            year, cve
          )
          if (response.data === null) {
            toast.error('Not Found', {
              position: "top-right",
              autoClose: 5000,
              hideProgressBar: false,
              closeOnClick: true,
              pauseOnHover: true,
              draggable: true,
              progress: undefined,
            });
          } else {
            toast.success('Data Found', {
              position: "top-right",
              autoClose: 5000,
              hideProgressBar: false,
              closeOnClick: true,
              pauseOnHover: true,
              draggable: true,
              progress: undefined,
            });
            setData(response.data)
          }

        } catch (error) {
          toast.error('Error submitting request', {
            position: "top-right",
            autoClose: 5000,
            hideProgressBar: false,
            closeOnClick: true,
            pauseOnHover: true,
            draggable: true,
            progress: undefined,
          });
        }
      }
      setSend(false);
      getCve();

    }

  }, [send])

  const sendNewRequest = () => {
    if (cve) {
      setSend(true)
    } else {
      toast.warn('Cve or Year is empty...', {
        position: "top-right",
        autoClose: 5000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
        progress: undefined,
      });
    }
  }

  const setNewValueCve = (changes) => {
    if (changes.target.value.match("^[0-9]{0,5}$") != null) {
      setCve(changes.target.value);
    }
  }

  const setNewValueYear = (changes) => {
    if (changes.target.value.match("^[0-9]{0,5}$") != null) {
      setYear(changes.target.value);
    }
  }

  return (
    <>
      <div className="search">
        <div className="search-bar">
          <div>
            <h1 className="subtitle">Year</h1>
            <input type="text" maxLength={4} placeholder="Year" onChange={setNewValueYear} value={year} />
          </div>
          <div>
            <h1 className="subtitle">CVE</h1>
            <input type="text" maxLength={5} placeholder="CVE" onChange={setNewValueCve} value={cve} />
          </div>
          <button className="button btn-find" onClick={sendNewRequest}><span>Search</span></button>

        </div>

        <Table
          dataTable={data}
        />
        <ToastContainer
          position="top-right"
          autoClose={5000}
          hideProgressBar={false}
          newestOnTop={false}
          closeOnClick
          rtl={false}
          pauseOnFocusLoss
          draggable
          pauseOnHover
        />

      </div>

    </>
  )
}



