import "./table.style.css"
import Modal from 'react-modal';
import { useState } from "react";

export const Table = ({ dataTable }) => {
    const [modalIsOpen, setIsOpen] = useState(false);
    const [summary, setSummary] = useState();
    const [tableScoreView, setTableScoreView] = useState(false);
    const [base, setBase] = useState();
    const [temporal, setTemporal] = useState();
    const [environmental, setEnvoronmental] = useState();


    const customStyles = {
        content: {
            top: '50%',
            left: '50%',
            right: 'auto',
            bottom: 'auto',
            marginRight: '-50%',
            width: '60%',
            transform: 'translate(-50%, -50%)',
        },
    };

    const closeModal = () => {
        setIsOpen(false);
    }

    const openModal = () => {
        setIsOpen(true);
    }

    const getScore = () => {
        let str = dataTable['cvss3-vector'];
        //using lib
        let cvss = require('cvss');
        //replace cvss 3.1 -> 3.0
        let newstr = str.replace(/3.1/i, '3.0');
        var score = cvss.getAll(newstr);

        //setting data
        setBase(score.base);
        setEnvoronmental(score.environmental);
        setTemporal(score.temporal);

        //enable view
        setTableScoreView(true)
    }

    return (
        <>
            {dataTable ?
                <div className="data">

                    <span className="span-table">
                        <table className="data-table">
                            <caption className="caption">Overview</caption>
                            <thead>
                                <tr>
                                    <th>CWE</th>
                                    <th>Summary</th>
                                    <th>Modified</th>
                                    <th>Acess authentication</th>
                                    <th>Acess Complexity</th>
                                    <th>Acess Vector</th>
                                    <th>Score Impact</th>
                                </tr>

                            </thead>
                            <tbody>
                                <tr>
                                    <td>{dataTable?.cwe}</td>
                                    <td>{dataTable?.summary}</td>
                                    <td>{dataTable?.Modified}</td>
                                    <td>{dataTable?.access?.authentication}</td>
                                    <td>{dataTable?.access?.complexity}</td>
                                    <td>{dataTable?.access?.vector}</td>
                                    <td>{dataTable?.impactScore3}</td>
                                </tr>

                            </tbody>

                        </table>


                    </span>
                    {dataTable.capec.length > 0 ?
                        <span className="span-table table-capec">
                            <table className="data-table">
                                <caption className="caption">Related Capec</caption>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Severity</th>
                                        <th>Name</th>
                                        <th>Summary</th>

                                    </tr>

                                </thead>
                                <tbody>

                                    <tr>
                                        <td>{dataTable.capec[dataTable.capec.length - 1]?.id}</td>
                                        <td>{dataTable.capec[dataTable.capec.length - 1]?.typical_severity}</td>
                                        <td>{dataTable.capec[dataTable.capec.length - 1]?.name}</td>
                                        <td>
                                            <button className="button btn-summary" onClick={() => {
                                                setSummary(dataTable.capec[dataTable.capec.length - 1].summary)
                                                openModal()
                                            }}
                                            >
                                                click to view
                                            </button>
                                        </td>

                                    </tr>
                                    <tr>
                                        <td>{dataTable.capec[dataTable.capec.length - 2]?.id}</td>
                                        <td>{dataTable.capec[dataTable.capec.length - 2]?.typical_severity}</td>
                                        <td>{dataTable.capec[dataTable.capec.length - 2]?.name}</td>
                                        <td>
                                            <button className="button btn-summary" onClick={() => {
                                                setSummary(dataTable.capec[dataTable.capec.length - 2].summary)
                                                openModal()
                                            }}
                                            >
                                                click to view
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>{dataTable.capec[dataTable.capec.length - 3]?.id}</td>
                                        <td>{dataTable.capec[dataTable.capec.length - 3]?.typical_severity}</td>
                                        <td>{dataTable.capec[dataTable.capec.length - 3]?.name}</td>
                                        <td>
                                            <button className="button btn-summary" onClick={() => {
                                                setSummary(dataTable.capec[dataTable.capec.length - 3].summary)
                                                openModal()
                                            }}
                                            >
                                                click to view
                                            </button>
                                        </td>
                                    </tr>


                                </tbody>

                            </table>
                        </span> : ""}

                    {tableScoreView ?
                        <span className="span-table table-capec">
                            <table className="data-table">
                                <caption className="caption">CVSS Scores</caption>
                                <thead>
                                    <tr>
                                        <th>Base</th>
                                        <th>Temporal</th>
                                        <th>Environmental</th>

                                    </tr>

                                </thead>
                                <tbody>

                                    <tr>
                                        <td>Score: {base.score}</td>
                                        <td>Score: {temporal.score}</td>
                                        <td>Score: {environmental.score}</td>

                                    </tr>
                                    <tr>
                                        <td>Rating: {base.rating}</td>
                                        <td>Rating: {temporal.rating}</td>
                                        <td>Rating: {environmental.rating}</td>
                                    </tr>

                                </tbody>

                            </table>
                        </span>

                        :
                        ""

                    }

                    <Modal
                        isOpen={modalIsOpen}
                        onRequestClose={closeModal}
                        style={customStyles}
                        contentLabel="Example Modal"
                        ariaHideApp={false}
                    >
                        <button className="button" onClick={closeModal}>close</button>
                        <div>
                            {summary}
                        </div>

                    </Modal>

                    <button className="button btn-align" onClick={getScore}><span>GET SCORE</span></button>


                </div>

                : ""}


        </>
    )
}



