import "./search.style.css"
import { useState, useEffect } from "react";
import { useCveApi } from "../../api/cveApi/useCveApi";
import { Table } from "../table/table";
import { ToastContainer, toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';

export const Search = () => {

  const [send, setSend] = useState(false);
  const [cve, setCve] = useState('');
  const [data, setData] = useState();
  const cveApi = useCveApi();


  useEffect(() => {
    if (send) {
      async function getCve() {
        try {
          toast.warn('Loading...', {
            position: "top-right",
            autoClose: 5000,
            hideProgressBar: false,
            closeOnClick: true,
            pauseOnHover: true,
            draggable: true,
            progress: undefined,
          });
          const response = await cveApi.GetCve(
            cve
          )
          if (response.data === null) {
            toast.error('Not Found', {
              position: "top-right",
              autoClose: 5000,
              hideProgressBar: false,
              closeOnClick: true,
              pauseOnHover: true,
              draggable: true,
              progress: undefined,
            });
            console.log(response.data);
          } else {
            toast.success('Data Found', {
              position: "top-right",
              autoClose: 5000,
              hideProgressBar: false,
              closeOnClick: true,
              pauseOnHover: true,
              draggable: true,
              progress: undefined,
              });
            setData(response.data)
            console.log(response.data);
          }

        } catch (error) {
          toast.error('Error submitting request', {
            position: "top-right",
            autoClose: 5000,
            hideProgressBar: false,
            closeOnClick: true,
            pauseOnHover: true,
            draggable: true,
            progress: undefined,
          });
          console.log(error)
        }
      }
      setSend(false);
      getCve();

    }

  }, [send])

  const sendNewRequest = () => {
    if(cve){
      setSend(true)
    }else{
      toast.warn('Cve is empty...', {
        position: "top-right",
        autoClose: 5000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
        progress: undefined,
      });
    }
  }

  const setNewValue = (changes) => {
    if(changes.target.value.match("^[0-9]{0,5}$")!=null) {
      setCve(changes.target.value);
    }
  }

  return (
    <>
      <div className="search">
        <h1>Search for CVE</h1>
        <input type="text" maxLength={5} placeholder="CVE" onChange={setNewValue} value={cve}/>
        <button className="button" onClick={sendNewRequest}><span>Search</span></button>
        <Table
          dataTable={data}
        />
        <ToastContainer
          position="top-right"
          autoClose={5000}
          hideProgressBar={false}
          newestOnTop={false}
          closeOnClick
          rtl={false}
          pauseOnFocusLoss
          draggable
          pauseOnHover
        />      </div>

    </>
  )
}



